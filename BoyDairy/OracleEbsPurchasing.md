---
title: Oracle ERP Purchase 常用SQL
author: Bill Liu
date: 2020/03/13
---

## 收料未轉入MES系統

UM_RCV_SHIPMENT_LINES_T1的TRIGGER未啟動

UPDATE RCV_SHIPMENT_LINE
SET QUANTITY_RECEIVED = QUANTITY_RECEIVED
WHERE 唯一條件即可

```sql
SELECT
    RT.TRANSACTION_ID
  , RT.QUANTITY /*正常狀況下,RCV_TRANSACTIONS.QUANTITY = RCV_SHIPMENT_LINES.QUANTITY_RECEIVED */
  , RSL.QUANTITY_RECEIVED /*正常狀況下,RCV_TRANSACTIONS.QUANTITY = RCV_SHIPMENT_LINES.QUANTITY_RECEIVED */
  , PHA.SEGMENT1
  , PLA.LINE_NUM
  , PLA.QUANTITY
  , RSH.RECEIPT_NUM
  , RSL.LINE_NUM
  , RT.TRANSACTION_TYPE
  , PLLA.QUANTITY_RECEIVED
  , PLLA.QUANTITY_SHIPPED
  , PLLA.SHIPMENT_NUM
  , RSL.PO_LINE_LOCATION_ID
FROM
    RCV_TRANSACTIONS     RT
  , RCV_SHIPMENT_LINES   RSL
  , RCV_SHIPMENT_HEADERS RSH
  , PO_HEADERS_ALL       PHA
  , PO_LINES_ALL         PLA
  , PO_LINE_LOCATIONS    PLLA
WHERE 1=1
    AND RT.PO_HEADER_ID         = PHA.PO_HEADER_ID
    AND RT.PO_LINE_ID           = PLA.PO_LINE_ID
    AND RT.PO_LINE_ID           = PLLA.PO_LINE_ID
    AND RT.SHIPMENT_HEADER_ID   = RSH.SHIPMENT_HEADER_ID
    AND RT.SHIPMENT_LINE_ID     = RSL.SHIPMENT_LINE_ID
    AND RSL.PO_LINE_LOCATION_ID = PLLA.LINE_LOCATION_ID
/*------下面這些條件自己下-------------------------------*/
    AND RT.CREATION_DATE >= TO_DATE('2020/05/15', 'YYYY/MM/DD')
    AND RSH.RECEIPT_NUM   = '50745914'
    --   AND PHA.SEGMENT1 = '30Y00040'
    AND RT.TRANSACTION_TYPE = 'RECEIVE'
;
```


## PO無法Approve

### 可能原因
1. Vendor失效(請user維護 Site，而非Vendor)
2. 人沒有權限(看Setup Employee)
3. 金額太大(超過2000萬台幣)

## PO無法取消

## GPO判斷

<p>直接判斷，PO_HEADERS_ALL.BILL_TO_LOCATION_ID != PO_HEADER_ALL.SHIP_TO_LOCATION_ID</p>

```sql
-- Smart Query 收料未入庫明細表
SELECT GC.SEGMENT1 || '.' || GC.SEGMENT2 || '.' || GC.SEGMENT3 || '.' ||
       GC.SEGMENT4 || '.' || GC.SEGMENT5 || '.' || GC.SEGMENT6 || '.' ||
       GC.SEGMENT7 || '.' || GC.SEGMENT8 AS ACCT_NO,
       GC.SEGMENT3,
       --gc.SEGMENT8,
       --gc.SEGMENT9,
       --gc.SEGMENT10,
       RH.RECEIPT_NUM,
       TO_CHAR(RT.TRANSACTION_DATE, 'yyyymmdd') RECEIPT_DATE,
       PH.SEGMENT1 PO_NUMBER,
       DECODE(PH.BILL_TO_LOCATION_ID, PH.SHIP_TO_LOCATION_ID, 'PO', 'GPO') PO,
       PV.VENDOR_NAME,
       MSI.INVENTORY_ITEM_ID,
       MSI.SEGMENT1 ITEM_NO,
       '',
       MU.UOM_CODE,
       RT.TRANSACTION_ID,
       RT.SHIPMENT_HEADER_ID,
       RT.SHIPMENT_LINE_ID,
       RT.QUANTITY,
       '',
       '',
       '',
       '',
       '',
       '',
       RT.ORGANIZATION_ID,
       RT.CURRENCY_CODE,
       RT.PO_UNIT_PRICE,
       RT.CURRENCY_CONVERSION_RATE,
       ENTERED_DR,
       ENTERED_CR,
       ACCOUNTED_DR,
       ACCOUNTED_CR,
       RS.CURRENCY_CODE,
       RS.CURRENCY_CONVERSION_RATE,
       RS.FUNCTIONAL_CURRENCY_CODE
  FROM RCV_SHIPMENT_HEADERS     RH,
       RCV_SHIPMENT_LINES       RL,
       RCV_TRANSACTIONS         RT,
       PO_VENDORS               PV,
       MTL_SYSTEM_ITEMS         MSI,
       PO_HEADERS_ALL           PH,
       MTL_UNITS_OF_MEASURE_TL  MU,
       RCV_RECEIVING_SUB_LEDGER RS,
       GL_CODE_COMBINATIONS     GC
--       ,um_internal_transfer_lines_v b
 WHERE RT.ORGANIZATION_ID = RH.SHIP_TO_ORG_ID
   AND RT.TRANSACTION_TYPE = 'RECEIVE'
   AND RT.TRANSACTION_DATE >= TO_DATE('2020/07/13', 'YYYY/MM/DD')
   AND RT.TRANSACTION_DATE < TO_DATE('2020/07/17', 'YYYY/MM/DD')
      --    and rt.organization_id = p_organization_id
   AND RT.SHIPMENT_HEADER_ID = RH.SHIPMENT_HEADER_ID
   AND RT.SHIPMENT_LINE_ID = RL.SHIPMENT_LINE_ID
   AND RT.TRANSACTION_ID = RS.RCV_TRANSACTION_ID
   AND GC.CODE_COMBINATION_ID = RS.CODE_COMBINATION_ID
   AND RS.ENTERED_CR IS NOT NULL
   AND RT.VENDOR_ID = PV.VENDOR_ID
   AND RL.ITEM_ID = MSI.INVENTORY_ITEM_ID
   AND RT.UNIT_OF_MEASURE = MU.UNIT_OF_MEASURE
   AND MU.LANGUAGE = 'US'
   AND MSI.ORGANIZATION_ID = RH.SHIP_TO_ORG_ID
   AND PH.PO_HEADER_ID = RT.PO_HEADER_ID
   AND RT.TRANSACTION_ID NOT IN (207216)
      -- 這個條件就是GPO
   AND PH.BILL_TO_LOCATION_ID != PH.SHIP_TO_LOCATION_ID


```

## PR PO互查



   ```sql
    SELECT POH. PO_HEADER_ID, POH. SEGMENT1 "PO NO" , PRHA .SEGMENT1 "REQUISTION NO" 
    FROM PO_HEADERS_ALL POH, 
        PO_DISTRIBUTIONS_ALL PDA ,
        PO_REQ_DISTRIBUTIONS_ALL PRDA ,
        PO_REQUISITION_LINES_ALL PRLA ,
        PO_REQUISITION_HEADERS_ALL PRHA
    WHERE POH. PO_HEADER_ID = PDA. PO_HEADER_ID 
    AND    PDA. REQ_DISTRIBUTION_ID = PRDA.DISTRIBUTION_ID
    AND    PRDA. REQUISITION_LINE_ID = PRLA. REQUISITION_LINE_ID
    AND      PRLA. REQUISITION_HEADER_ID = PRHA. REQUISITION_HEADER_ID
    --AND   POH.SEGMENT1 = '&PoNumber'  -- PO NUMBER 
    AND    PRHA. SEGMENT1 = '&PoRequisitionNumber'   -- PO REQUISITION NUMBER
   ```


## Sourcing Rule查詢
ALTER SESSION SET NLS_LANGUAGE = 'AMERICAN';

SELECT 
MRP_SOURCING_RULES.ORGANIZATION_ID,
MRP_SOURCING_RULES.SOURCING_RULE_ID, 
org_organization_definitions.organization_code, 
MRP_SOURCING_RULES.SOURCING_RULE_NAME, 
MRP_SOURCING_RULES.DESCRIPTION, 
MRP_SOURCING_RULES.STATUS, 
MRP_SOURCING_RULES.SOURCING_RULE_TYPE, 
MRP_SOURCING_RULES.PLANNING_ACTIVE, 
MRP_SR_RECEIPT_ORG_V.effective_date,
MRP_SR_RECEIPT_ORG_V.disable_date,
AP_VENDORS_V.VENDOR_NAME, 
po_vendor_sites_all.VENDOR_SITE_CODE, 
MRP_SR_SOURCE_ORG.RANK, 
MRP_SR_SOURCE_ORG.ALLOCATION_PERCENT 


--SELECT DISTINCT MRP_SOURCING_RULES.SOURCING_RULE_NAME
FROM MRP_SOURCING_RULES 
LEFT JOIN MRP_SR_RECEIPT_ORG_V ON MRP_SR_RECEIPT_ORG_V.SOURCING_RULE_ID=MRP_SOURCING_RULES.SOURCING_RULE_ID 
LEFT JOIN MRP_SR_SOURCE_ORG ON MRP_SR_SOURCE_ORG.SR_RECEIPT_ID=MRP_SR_RECEIPT_ORG_V.SR_RECEIPT_ID 
LEFT JOIN AP_VENDORS_V ON AP_VENDORS_V.VENDOR_ID=MRP_SR_SOURCE_ORG.VENDOR_ID 
LEFT JOIN po_vendor_sites_all ON po_vendor_sites_all.VENDOR_SITE_ID=MRP_SR_SOURCE_ORG.VENDOR_SITE_ID 
LEFT JOIN org_organization_definitions ON org_organization_definitions.ORGANIZATION_ID=MRP_SOURCING_RULES.ORGANIZATION_ID 
WHERE 1=1
AND   MRP_SR_RECEIPT_ORG_V.disable_date IS NULL
--AND   MRP_SOURCING_RULES.SOURCING_RULE_NAME =  '10G472X5KY01'
AND   MRP_SR_SOURCE_ORG.ALLOCATION_PERCENT < 100
AND   MRP_SR_SOURCE_ORG.ALLOCATION_PERCENT > 0
--AND   MRP_SOURCING_RULES.SOURCING_RULE_NAME = '20G1003DJC01'
--AND   MRP_SOURCING_RULES.ORGANIZATION_ID IN (84)
--(select organization_id from org_organization_definitions where (organization_code = 'XXX' OR organization_code = 'XXY' )) 



--------------------------------------
SELECT msr.SOURCING_RULE_NAME "Name"
, msr.DESCRIPTION 
, mp.ORGANIZATION_CODE "ORG Code"
, DECODE(msr.PLANNING_ACTIVE
, 1, 'Y'
, 2, 'N') "Planning Active"
--, " "[Effective Dates]"
, msrov.EFFECTIVE_DATE "From Date"
, msrov.DISABLE_DATE "To Date"
--, " "[Shipping Organization]"
, DECODE(mssov.SOURCE_TYPE
, 3, 'Buy From'
, 'Transfer From') "TYPE"
, mssov.SOURCE_ORGANIZATION_CODE "Org"
, mssov.VENDOR_NAME "Supplier"
, mssov.VENDOR_SITE "Site"
, mssov.ALLOCATION_PERCENT "Allocation %"
, mssov.RANK "Rank"
, mssov.SHIP_METHOD "Shipping Method"
, mssov.INTRANSIT_TIME "Intransit Time"
FROM MRP_SOURCING_RULES msr
, MTL_PARAMETERS mp
, MRP_SR_RECEIPT_ORG_V msrov
, MRP_SR_SOURCE_ORG_V mssov
WHERE 1=1
AND msr.SOURCING_RULE_NAME = '20G1003DJC01'
AND msrov.DISABLE_DATE IS NULL
AND msr.ORGANIZATION_ID = mp.ORGANIZATION_ID (+)
AND msr.SOURCING_RULE_ID = msrov.SOURCING_RULE_ID (+)
AND msrov.SR_RECEIPT_ID = mssov.SR_RECEIPT_ID (+)
ORDER BY msr.SOURCING_RULE_NAME
, msrov.EFFECTIVE_DATE
, msrov.DISABLE_DATE
, DECODE(mssov.SOURCE_TYPE
, 3, 'Buy From'
, 'Transfer From')
, mssov.SOURCE_ORGANIZATION_CODE
, mssov.VENDOR_NAME
, mssov.VENDOR_SITE
, mssov.ALLOCATION_PERCENT
, mssov.RANK


From: TW-1110-劉柏余 
Sent: Monday, April 29, 2019 11:33 AM
To: TW-1100-張芳銘
Cc: TW-1110-謝政衛; TW-1110-顏俊年
Subject: 目前還是有少數料號有多家供應商的情形

Dear 經理：

不好意思，

稍早我的回答錯了！

目前還是有少數料號有多家供應商的情形(目前我查到有95種料號有這些狀況)

但大多數的料號都只會配到一家供應商

 

Best Regards,

Bill Liu 劉柏余
UMEC MIS Dept. 資訊部
04-23590096 Ext. 1132

